# 06.1 - Row-Level Security Patterns

## Overview

Row-Level Security (RLS) in Power BI controls which rows of data users can see based on their identity, enabling secure multi-tenant reports where different users see different subsets of the same dataset without duplicating reports or data. In healthcare environments, RLS is critical for HIPAA compliance, ensuring providers only access data for their attributed patients, facilities see only their locations' data, and care coordinators access only patients in their assigned programs. Properly implemented RLS combines security table design, DAX filter expressions, and role testing to create seamless, secure user experiences.

## Key Principles

- **Security Tables Define User-to-Data Mappings**: Create dedicated security tables (separate from dimension tables) that map user identities (email addresses or AD groups) to the data they're authorized to see (provider IDs, facility IDs, patient lists). Security tables drive RLS filter logic.

- **Use Dynamic RLS with USERNAME() or USERPRINCIPALNAME()**: Dynamic RLS uses DAX functions to detect the current user's identity and filter data accordingly. This scales better than static RLS (hard-coded roles) and requires no report republishing when users change.

- **Apply RLS Filters to Dimension Tables, Not Facts**: Filter dimension tables (DimPatient, DimProvider, DimFacility) with RLS rules. Filters automatically propagate to fact tables via relationships. This approach is more performant and maintainable than filtering large fact tables directly.

- **Test RLS Thoroughly with View As Feature**: Never deploy RLS without testing. Use "View as" feature in Power BI Desktop and Service to impersonate users and verify they see correct data. Test edge cases: users with no access, users with access to multiple entities, users not in security table.

- **Document RLS Logic and Maintain Security Tables**: RLS failures expose PHI to unauthorized users - a HIPAA violation. Document RLS implementation, maintain security tables with IT/HR processes, and audit RLS effectiveness regularly.

## Practical Example

### Example 1: Provider-Level RLS (Providers See Their Attributed Patients)

**Business Requirement**: Providers should only see data for patients attributed to them. Dr. Smith sees only Dr. Smith's patients, Nurse Jones sees only Nurse Jones' patients.

**Step 1: Create Security Table**

```sql
-- In SQL Server or Power Query
CREATE TABLE Security.ProviderSecurity (
    UserEmail VARCHAR(200),           -- User's email (from Azure AD)
    ProviderKey INT,                  -- Provider they can access
    ProviderName VARCHAR(200)         -- For display/validation
);

-- Populate from HR/credentialing system
INSERT INTO Security.ProviderSecurity (UserEmail, ProviderKey, ProviderName)
VALUES
    ('john.smith@absolutecare.com', 101, 'Dr. John Smith'),
    ('sarah.jones@absolutecare.com', 102, 'Sarah Jones, NP'),
    ('mike.williams@absolutecare.com', 103, 'Dr. Mike Williams');
```

**Step 2: Load Security Table in Power BI**

```powerquery
// Power Query
let
    Source = Sql.Database("ABCDW-Prod", "Healthcare"),
    SecurityTable = Source{[Schema="Security",Item="ProviderSecurity"]}[Data]
in
    SecurityTable
```

**Important**: Do NOT create relationship between Security.ProviderSecurity and DimProvider. Security tables remain unrelated to model.

**Step 3: Create RLS Role in Power BI Desktop**

1. Go to **Modeling** ribbon ’ **Manage roles**
2. Click **Create** ’ Name: "Provider RLS"
3. Select table: **DimProvider**
4. Add filter expression:

```dax
[ProviderKey] IN
    VALUES(
        FILTER(
            Security_ProviderSecurity,
            Security_ProviderSecurity[UserEmail] = USERPRINCIPALNAME()
        ),
        Security_ProviderSecurity[ProviderKey]
    )
```

**How This Works**:
- `USERPRINCIPALNAME()` returns current user's email (john.smith@absolutecare.com)
- `FILTER` finds rows in Security_ProviderSecurity where UserEmail matches
- `VALUES` extracts ProviderKey values user has access to
- `[ProviderKey] IN (...)` filters DimProvider to only those providers
- Filter propagates to FactEncounters via DimProvider’FactEncounters relationship

**Step 4: Test RLS in Power BI Desktop**

1. **Modeling** ribbon ’ **View as**
2. Check **Other user** ’ Enter: john.smith@absolutecare.com
3. Check **Provider RLS** role
4. Click **OK**

Report now shows only data for ProviderKey = 101 (Dr. Smith's patients).

**Step 5: Publish and Assign Users to Role**

1. Publish report to Power BI Service
2. Go to workspace ’ Dataset settings ’ Security
3. Select **Provider RLS** role
4. Add users:
   - Type: People
   - Enter: john.smith@absolutecare.com
   - Or add entire AD group: AbsoluteCare_Providers

### Example 2: Multi-Level RLS (Providers + Managers See Team Data)

**Business Requirement**: Providers see their patients. Managers see all patients for providers in their practice.

**Security Table Design**:

```sql
CREATE TABLE Security.ProviderSecurity (
    UserEmail VARCHAR(200),
    ProviderKey INT,
    AccessLevel VARCHAR(50)           -- 'Self' or 'Practice Manager'
);

INSERT INTO Security.ProviderSecurity VALUES
    ('john.smith@absolutecare.com', 101, 'Self'),     -- Dr. Smith sees his patients
    ('sarah.manager@absolutecare.com', 101, 'Practice Manager'),  -- Manager sees Dr. Smith's patients
    ('sarah.manager@absolutecare.com', 102, 'Practice Manager'),  -- Manager also sees NP Jones' patients
    ('sarah.manager@absolutecare.com', 103, 'Practice Manager');  -- Manager sees Dr. Williams' patients
```

**RLS DAX** (same as Example 1 - no change needed):

```dax
-- DimProvider table filter
[ProviderKey] IN
    VALUES(
        FILTER(
            Security_ProviderSecurity,
            Security_ProviderSecurity[UserEmail] = USERPRINCIPALNAME()
        ),
        Security_ProviderSecurity[ProviderKey]
    )
```

**Why This Works**: Sarah Manager's email appears multiple times in security table (for ProviderKeys 101, 102, 103). The filter returns all three ProviderKeys, giving her access to all three providers' data.

### Example 3: Facility-Level RLS with Multiple Facilities Per User

**Business Requirement**: Regional directors see data for multiple facilities they oversee.

**Security Table**:

```sql
CREATE TABLE Security.FacilitySecurity (
    UserEmail VARCHAR(200),
    FacilityKey INT,
    FacilityName VARCHAR(200)
);

INSERT INTO Security.FacilitySecurity VALUES
    ('regional.director@absolutecare.com', 10, 'North Clinic'),
    ('regional.director@absolutecare.com', 11, 'South Clinic'),
    ('regional.director@absolutecare.com', 12, 'East Hospital'),
    ('site.manager@absolutecare.com', 10, 'North Clinic');  -- Site manager sees only one facility
```

**RLS DAX on DimFacility**:

```dax
[FacilityKey] IN
    VALUES(
        FILTER(
            Security_FacilitySecurity,
            Security_FacilitySecurity[UserEmail] = USERPRINCIPALNAME()
        ),
        Security_FacilitySecurity[FacilityKey]
    )
```

**Testing**:
- Regional director sees encounters at facilities 10, 11, 12
- Site manager sees only facility 10 encounters

### Example 4: Combining Multiple RLS Dimensions

**Scenario**: Users might have both Provider-level and Facility-level access restrictions.

**Approach**: Create separate roles, assign both to user

**Roles**:
1. **Provider RLS** role: Filters DimProvider
2. **Facility RLS** role: Filters DimFacility

**Assign Both Roles to User**:
- In Power BI Service ’ Dataset Security
- Add user to both "Provider RLS" AND "Facility RLS" roles
- Power BI applies AND logic: user sees intersection of both filters

**Result**: User sees only encounters where:
- Provider matches their authorized providers AND
- Facility matches their authorized facilities

## Common Pitfalls

### L Pitfall 1: Creating Relationships Between Security Tables and Data Model

**Description**: Creating a relationship between Security.ProviderSecurity and DimProvider tables.

**Impact**:
- Relationship creates unintended filter propagation
- RLS DAX logic may not work as expected
- Security table data appears in visuals and field list
- Users may see security table data (exposing access control logic)

**Fix**: Security tables must remain **unrelated** to the data model. They exist only to support RLS DAX filter expressions. Mark security tables as "Hidden" in model view to prevent accidental use in reports.

### L Pitfall 2: Applying RLS to Fact Tables Instead of Dimensions

**Description**: Adding RLS filter directly to FactEncounters table instead of DimProvider or DimPatient.

**Impact**:
- Poor performance (filtering millions of fact rows vs thousands of dimension rows)
- Complex DAX logic duplicated across multiple fact tables
- Harder to maintain (change provider access = update multiple RLS rules)

**Fix**:
```dax
// WRONG: Filtering fact table directly
FactEncounters[ProviderKey] IN VALUES(Security_ProviderSecurity[ProviderKey])

// CORRECT: Filter dimension, let relationship propagate
DimProvider[ProviderKey] IN VALUES(FILTER(...))
```

Filter dimensions at the "one" side of 1:many relationships. Filters flow automatically to fact tables.

### L Pitfall 3: Not Testing RLS with Real User Accounts

**Description**: Testing RLS with "View as" using role names but not actual user email addresses.

**Impact**:
- Spelling errors in email addresses go undetected (john.smith vs jsmith)
- Case sensitivity issues (Power BI usernames are case-insensitive, but typos persist)
- Users not in security table see BLANK reports (confusing user experience)
- HIPAA violations when unauthorized users see PHI

**Fix**:
**Testing Checklist**:
```
 Test with actual user email from Azure AD
 Test user IN security table (should see their data)
 Test user NOT IN security table (should see nothing or error message)
 Test user with multiple access entries (manager with multiple providers)
 Test in Power BI Service (not just Desktop)
 Verify RLS works in mobile app
 Test with AD group assignments (not just individual users)
```

**Handling Users Not in Security Table**:

```dax
// Option 1: Show helpful message
IF(
    ISBLANK(
        COUNTROWS(
            FILTER(
                Security_ProviderSecurity,
                Security_ProviderSecurity[UserEmail] = USERPRINCIPALNAME()
            )
        )
    ),
    FALSE(),  // User not in security table = no data
    [ProviderKey] IN VALUES(...)
)

// Option 2: Create "No Access" measure for visual
No Access Message =
VAR UserInTable =
    COUNTROWS(
        FILTER(
            Security_ProviderSecurity,
            Security_ProviderSecurity[UserEmail] = USERPRINCIPALNAME()
        )
    )
RETURN
    IF(
        UserInTable = 0,
        "You do not have access to this report. Contact IT for access.",
        BLANK()
    )
```

Display "No Access Message" measure in card visual. If message appears, user knows they need access provisioning (better UX than blank report).

## Healthcare Context

### Performance Considerations

RLS impacts query performance:

**Dimension-Level RLS**: Minimal performance impact (<5% query time increase) when filtering small dimension tables (thousands of rows). This maintains <5 second SLA for clinical workflows.

**Fact-Level RLS**: Significant performance degradation (30-50% slower) when filtering large fact tables directly. Avoid filtering FactEncounters with millions of rows - filter DimProvider or DimPatient instead.

**Optimization**: If RLS queries become slow:
1. Add indexes to security table in SQL Server
2. Minimize security table size (remove inactive users)
3. Use aggregations (Premium feature) for RLS-filtered data

### Print/Mobile Implications

**Print Subscriptions with RLS**: When users receive emailed PDF subscriptions, RLS applies based on subscription recipient's identity. Each user receives PDF filtered to their authorized data automatically.

**Mobile App RLS**: Power BI mobile app respects RLS. Field providers viewing reports on tablets see only their patients. No additional mobile-specific RLS configuration needed.

### Compliance Notes

**HIPAA Requirements for RLS**:

**Access Controls**: RLS implements HIPAA's "minimum necessary" standard - users access only PHI required for their job function.

**Audit Trail**: Document RLS implementation:
- Which roles exist
- What data each role can access
- Who is assigned to each role
- When assignments change

**Security Table Maintenance**: Establish IT/HR process for:
- Adding users when hired (provision access within 24 hours)
- Removing users when terminated (revoke access immediately)
- Updating assignments when providers change (job transfers, new attributions)
- Quarterly access reviews (validate users still require access)

**Testing Requirements**: Test RLS changes in Dev/Test environments before production deployment. Never modify RLS in production without testing - could expose PHI to unauthorized users.

**Incident Response**: If RLS failure detected (user saw unauthorized data):
1. Immediately disable report or remove user access
2. Investigate root cause (security table error, RLS DAX bug, relationship issue)
3. Document breach (HIPAA breach notification may be required)
4. Fix issue in Dev, test thoroughly, redeploy
5. Notify affected patients if required by breach notification rules

## Learn More

### Official Documentation
- [Row-Level Security in Power BI](https://learn.microsoft.com/en-us/power-bi/enterprise/service-admin-rls) - Microsoft comprehensive RLS guide
- [Dynamic Row-Level Security with DAX](https://learn.microsoft.com/en-us/power-bi/guidance/rls-guidance) - Best practices for dynamic RLS

### Expert Resources
- [Implementing Row-Level Security](https://www.sqlbi.com/articles/row-level-security-in-power-bi/) - SQLBI article by Marco Russo with advanced patterns
- [RLS Best Practices](https://powerbi.tips/2020/10/row-level-security-best-practices/) - PowerBI.Tips guide to RLS implementation
- [Dynamic RLS Patterns](https://www.daxpatterns.com/row-level-security/) - DAX Patterns RLS examples

### Video Content
- [Row-Level Security Deep Dive](https://www.youtube.com/c/GuyinaCube) - Guy in a Cube RLS tutorial
- [Testing RLS Effectively](https://www.youtube.com/c/GuyinaCube) - Demonstration of "View as" and testing strategies

### Related Topics
- [06.2 - Workspace Roles & Permissions](06.2%20-%20Workspace%20Roles%20&%20Permissions.md) - Workspace-level security (complements RLS)
- [06.4 - Data Classification & Sensitivity Labels](06.4%20-%20Data%20Classification%20&%20Sensitivity%20Labels.md) - Additional data protection layers
- [01.1 - Star Schema Design Principles](../01%20-%20Data%20Architecture%20&%20Semantic%20Modeling/01.1%20-%20Star%20Schema%20Design%20Principles.md) - Dimension tables for RLS filtering
- [05.1 - Dev Test Prod Workspace Strategy](../05%20-%20Development%20Workflow%20&%20Version%20Control/05.1%20-%20Dev%20Test%20Prod%20Workspace%20Strategy.md) - Testing RLS across environments

---

*Last updated: October 2025*

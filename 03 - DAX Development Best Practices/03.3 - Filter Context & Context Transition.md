# 03.3 - Filter Context & Context Transition

## Overview

Filter context and context transition are the most fundamentaland most challengingconcepts in DAX. Filter context determines which rows of data are visible to a calculation based on report filters, slicers, and visual rows/columns. Context transition occurs when CALCULATE transforms row context (iterating through table rows) into filter context (filtering to specific rows). Misunderstanding these concepts leads to incorrect calculations, unpredictable measure behavior, and hours of debugging. Mastering filter context and context transition enables developers to write measures that behave correctly across any report filter combinationessential for healthcare analytics where filtering by facility, provider, date, and patient attributes must produce accurate results every time.

## Key Principles

- **Filter Context = What Rows Are Visible**: Created by report filters, slicers, visual rows/columnsdetermines which subset of data is active for measure calculation
- **Row Context = Iterating Through Rows**: Created by calculated columns, iterators (SUMX, FILTER), and table functionsprocesses one row at a time without awareness of other rows
- **CALCULATE Modifies Filter Context**: The only function that can change filter context mid-calculationadds, removes, or replaces filters on tables
- **Context Transition = Row í Filter**: When CALCULATE is used in row context (e.g., inside calculated column or SUMX), it creates filter context from current row values
- **Understanding Context Prevents Errors**: 90% of "why doesn't my measure work?" questions stem from context confusionvisualize context flow to debug effectively

## Practical Examples

### Example 1: Filter Context in Action

**Scenario:** Measure calculating total encounters behaves differently based on what's filtered in the report.

**Measure definition:**

```dax
Total Encounters = COUNTROWS(FactEncounter)
```

**How filter context affects this simple measure:**

```
Report State 1: No filters applied
  Filter context: ALL rows in FactEncounter
  Total Encounters = COUNTROWS(FactEncounter)
  Result: 2,500,000 encounters (entire fact table)

Report State 2: User selects "January 2025" in date slicer
  Filter context: FactEncounter filtered to January 2025 dates
  Total Encounters = COUNTROWS(FactEncounter)
  Result: 187,450 encounters (only January 2025)

Report State 3: User also selects "Main Campus" facility
  Filter context: FactEncounter filtered to January 2025 + Main Campus
  Total Encounters = COUNTROWS(FactEncounter)
  Result: 89,230 encounters (January 2025 at Main Campus only)

Report State 4: Visual shows encounters by Provider (matrix rows)
  Filter context changes for EACH provider row:
    Provider = "Dr. Smith" í 3,247 encounters
    Provider = "Dr. Jones" í 2,891 encounters
    Provider = "Dr. Lee" í 4,102 encounters
  Each row has different filter context (provider filter added automatically)
```

**Key insight:** The exact same measure (`COUNTROWS(FactEncounter)`) returns different values based on filter context. DAX doesn't "know" what filters are activeit just counts rows in whatever filtered table it receives.

**Visualizing filter context in matrix visual:**

```
Matrix: Encounters by Facility and Provider

                    | Total Encounters
--------------------|------------------
Main Campus         | 89,230           ê Filter context: Main Campus (row filter)
  Dr. Smith         | 3,247            ê Filter context: Main Campus + Dr. Smith
  Dr. Jones         | 2,891            ê Filter context: Main Campus + Dr. Jones
East Clinic         | 52,180           ê Filter context: East Clinic
  Dr. Lee           | 4,102            ê Filter context: East Clinic + Dr. Lee
--------------------|------------------
Total               | 187,450          ê Filter context: January 2025 (slicer)

Each cell has DIFFERENT filter context:
  - "Dr. Smith" cell: Facility = "Main Campus" AND Provider = "Dr. Smith"
  - "Main Campus" row total: Facility = "Main Campus" (all providers)
  - Grand Total: All facilities, all providers (only date slicer active)
```

### Example 2: CALCULATE Modifying Filter Context

**Scenario:** Calculate "% of Total Encounters" for each provider, ignoring provider filter to get grand total as denominator.

**Without CALCULATE (incorrect):**

```dax
// L WRONG: Denominator also filtered by provider
% of Total Encounters (Wrong) =
VAR ProviderEncounters = COUNTROWS(FactEncounter)  // Filtered by current provider
VAR TotalEncounters = COUNTROWS(FactEncounter)     // ALSO filtered by current provider!
RETURN
    DIVIDE(ProviderEncounters, TotalEncounters, 0)

Result in matrix:
Provider        | % of Total
----------------|------------
Dr. Smith       | 100%       ê WRONG! (3,247 / 3,247 = 100%)
Dr. Jones       | 100%       ê WRONG! (2,891 / 2,891 = 100%)
Dr. Lee         | 100%       ê WRONG! (4,102 / 4,102 = 100%)

Problem: Both numerator AND denominator have same filter context (current provider)
         Numerator: Encounters for Dr. Smith
         Denominator: Encounters for Dr. Smith (should be ALL providers)
```

**With CALCULATE to remove provider filter (correct):**

```dax
//  CORRECT: Remove provider filter for denominator
% of Total Encounters =
VAR ProviderEncounters =
    COUNTROWS(FactEncounter)  // Respects provider filter (numerator)

VAR TotalEncounters =
    CALCULATE(
        COUNTROWS(FactEncounter),
        ALL(DimProvider)  // Remove provider filter (denominator = all providers)
    )

RETURN
    DIVIDE(ProviderEncounters, TotalEncounters, 0)

Result in matrix:
Provider        | Encounters | % of Total
----------------|------------|------------
Dr. Smith       | 3,247      | 3.6%        (3,247 / 89,230)
Dr. Jones       | 2,891      | 3.2%        (2,891 / 89,230)
Dr. Lee         | 4,102      | 4.6%        (4,102 / 89,230)
----------------|------------|------------
Total           | 89,230     | 100%       

How CALCULATE works:
  For "Dr. Smith" row:
    1. Outer filter context: Facility = Main Campus, Provider = Dr. Smith
    2. ProviderEncounters: COUNTROWS respects filter í 3,247
    3. TotalEncounters: CALCULATE removes Provider filter
       - Filter context inside CALCULATE: Facility = Main Campus, ALL providers
       - COUNTROWS í 89,230 (all Main Campus providers)
    4. DIVIDE(3,247, 89,230) = 3.6%
```

**CALCULATE filter modification patterns:**

```dax
// Pattern 1: Remove all filters from a table
CALCULATE(
    <expression>,
    ALL(DimProvider)  // Remove ALL filters on DimProvider
)

// Pattern 2: Remove specific column filters
CALCULATE(
    <expression>,
    ALL(DimProvider[ProviderName])  // Remove filter on ProviderName only
)

// Pattern 3: Keep only certain filters (remove everything except...)
CALCULATE(
    <expression>,
    ALLEXCEPT(FactEncounter, DimDate[Date])  // Remove all filters except Date
)

// Pattern 4: Replace filter (override existing filter)
CALCULATE(
    <expression>,
    DimPatient[RiskLevel] = "High"  // Replace RiskLevel filter with "High"
)

// Pattern 5: Add filter (combine with existing filters)
CALCULATE(
    <expression>,
    FILTER(
        ALL(DimFacility),
        DimFacility[FacilityType] = "Hospital"  // Add additional filter
    )
)
```

### Example 3: Context Transition (Row Context í Filter Context)

**Scenario:** Calculated column showing each patient's percentage of total encounters. Requires understanding when row context transitions to filter context.

**Without context transition (incorrect):**

```dax
// DimPatient table - Calculated Column
// L WRONG: Doesn't work as expected
Patient % of Encounters =
VAR PatientEncounters =
    COUNTROWS(RELATED(FactEncounter))  // Row context, related encounters
VAR TotalEncounters =
    COUNTROWS(FactEncounter)  // No filter context! Counts ALL encounters
RETURN
    DIVIDE(PatientEncounters, TotalEncounters, 0)

Result:
PatientKey | PatientName  | Patient % of Encounters
-----------|--------------|------------------------
1001       | John Smith   | 0.0001%    ê WRONG!
1002       | Jane Doe     | 0.0002%    ê WRONG!

Problem:
  - PatientEncounters: Uses RELATED to get encounters for current patient (correct)
  - TotalEncounters: COUNTROWS in row context counts ALL 2.5M encounters (wrong)
  - Should get "this patient's encounters / all encounters"
  - Instead getting "this patient's encounters / 2.5M encounters" (denominator not patient-specific)
```

**With CALCULATE creating filter context (correct):**

```dax
// DimPatient table - Calculated Column
//  CORRECT: CALCULATE creates filter context from current row
Patient % of Encounters =
VAR PatientEncounters =
    CALCULATE(
        COUNTROWS(FactEncounter)
        // CALCULATE in row context triggers CONTEXT TRANSITION
        // Current row's PatientKey becomes filter context
        // Counts encounters WHERE PatientKey = current row's PatientKey
    )
VAR TotalEncounters =
    CALCULATE(
        COUNTROWS(FactEncounter),
        ALL(DimPatient)  // Remove patient filter to get all encounters
    )
RETURN
    DIVIDE(PatientEncounters, TotalEncounters, 0)

Result:
PatientKey | PatientName  | Patient % of Encounters
-----------|--------------|------------------------
1001       | John Smith   | 0.12%       (3,247 / 2,500,000)
1002       | Jane Doe     | 0.08%       (2,134 / 2,500,000)

How context transition works:
  For PatientKey = 1001 row:
    1. Row context: DimPatient table, row for PatientKey = 1001
    2. PatientEncounters variable:
       - CALCULATE is called in row context í CONTEXT TRANSITION occurs
       - Row context values (PatientKey = 1001) become filter context
       - Filter context: FactEncounter WHERE PatientKey = 1001
       - COUNTROWS í 3,247 encounters for this patient
    3. TotalEncounters variable:
       - CALCULATE with ALL(DimPatient) í removes patient filter
       - Filter context: ALL encounters (no patient filter)
       - COUNTROWS í 2,500,000 total encounters
    4. DIVIDE(3,247, 2,500,000) = 0.12%
```

**Context transition visualization:**

```
Calculated column evaluation for PatientKey = 1001:

BEFORE context transition (row context only):
                                     
 DimPatient table (row context)      
 Current row: PatientKey = 1001      
                                     
 FactEncounter (no filter)           
 All 2.5M rows visible                ê PROBLEM: Can't relate to patient
                                     

AFTER context transition (CALCULATE creates filter context):
                                     
 DimPatient table (row context)      
 Current row: PatientKey = 1001      
         ì Context Transition        
 FactEncounter (filter context)      
 WHERE PatientKey = 1001               Now filtered to current patient
 3,247 rows visible                  
                                     
```

**When context transition occurs:**

```
Context transition happens when CALCULATE is used in row context:

1. Calculated columns:
   Patient Encounter Count =
   CALCULATE(COUNTROWS(FactEncounter))  ê Context transition occurs

2. Iterator functions (SUMX, FILTER, etc.):
   Total Revenue =
   SUMX(
       DimPatient,
       CALCULATE([Patient Revenue])  ê Context transition occurs for each patient
   )

3. Table functions with row iteration:
   High Value Patients =
   FILTER(
       DimPatient,
       CALCULATE([Patient Lifetime Value]) > 10000  ê Context transition
   )

NO context transition in these cases:
   - Measures (no row context)
   - RELATED (uses relationship, not context transition)
   - Direct column references (e.g., DimPatient[PatientName])
```

## Common Pitfalls

### Pitfall 1: Expecting Measures to Work Like Calculated Columns

Using measures inside calculated columns or iterators without understanding context transition, leading to incorrect results or circular dependency errors.

**Impact**: Measures return unexpected values in calculated columns (wrong context), circular dependency errors when calculated column references measure that references same column, confusing error messages ("A circular dependency was detected"), incorrect aggregations (measure evaluated in wrong context).

**Example mistake:**

```dax
// DimPatient table - Calculated Column
// L WRONG: Using measure directly in calculated column
Patient Risk Category =
VAR RiskScore = [Patient Risk Score]  // [Patient Risk Score] is a MEASURE
RETURN
    SWITCH(
        TRUE(),
        RiskScore >= 75, "High",
        RiskScore >= 50, "Medium",
        "Low"
    )

Problems:
1. Measures don't have row context automatically
2. [Patient Risk Score] evaluates in current filter context (not current patient)
3. In calculated column, filter context might be "all patients" í wrong result
4. Could cause circular dependency if measure references DimPatient
```

**Fix: Use CALCULATE for context transition**

```dax
// DimPatient table - Calculated Column
//  CORRECT: CALCULATE creates filter context for measure
Patient Risk Category =
VAR RiskScore =
    CALCULATE([Patient Risk Score])  // Context transition: current patient row
RETURN
    SWITCH(
        TRUE(),
        RiskScore >= 75, "High",
        RiskScore >= 50, "Medium",
        "Low"
    )

Now works correctly:
  - CALCULATE in row context triggers context transition
  - Current PatientKey becomes filter context
  - [Patient Risk Score] measure evaluates for current patient
  - RiskScore variable contains correct value for this patient
```

**Alternative: Don't use measures in calculated columns**

```dax
// Better approach: Calculate risk score directly in column (avoid measure)
Patient Risk Category =
VAR ChronicConditions = DimPatient[ChronicConditionCount]
VAR RecentHospitalizations = DimPatient[HospitalizationsLast12Mo]
VAR RiskScore = (ChronicConditions * 15) + (RecentHospitalizations * 25)
RETURN
    SWITCH(
        TRUE(),
        RiskScore >= 75, "High",
        RiskScore >= 50, "Medium",
        "Low"
    )

Advantages:
  - No measure dependency (simpler)
  - No context transition needed (direct column references)
  - Easier to understand (all logic in one place)
  - No circular dependency risk
```

### Pitfall 2: Not Understanding ALL vs. ALLSELECTED

Using ALL() to remove filters when ALLSELECTED() is more appropriate, causing measures to ignore user slicers unexpectedly.

**Impact**: Measures ignore report slicers (users confused: "I selected January but total shows all months"), incorrect percentage calculations (denominator ignores important filters), poor user experience (filters don't work as expected), business users lose trust in report accuracy.

**Example mistake:**

```dax
// L WRONG: ALL removes ALL filters (including slicers)
% of Total Encounters =
VAR ProviderEncounters = COUNTROWS(FactEncounter)
VAR TotalEncounters =
    CALCULATE(
        COUNTROWS(FactEncounter),
        ALL(DimProvider),
        ALL(DimDate)  // Removes date slicer! Users expect date filter to apply
    )
RETURN
    DIVIDE(ProviderEncounters, TotalEncounters, 0)

User experience:
  Report State: User selects "January 2025" in date slicer
  Matrix:
    Provider    | Encounters | % of Total
    ------------|------------|------------
    Dr. Smith   | 245        | 0.01%      ê WRONG! (245 / 2,500,000 all-time)
    Dr. Jones   | 187        | 0.01%      ê Users expect % of January, not all-time

  User confusion: "I filtered to January, why is % of Total so small?"
  Expected: % of January total (245 / 18,450 = 1.3%)
  Actual: % of ALL-TIME total (245 / 2,500,000 = 0.01%)
```

**Fix: Use ALLSELECTED to respect slicers**

```dax
//  CORRECT: ALLSELECTED respects report-level filters
% of Total Encounters =
VAR ProviderEncounters = COUNTROWS(FactEncounter)
VAR TotalEncounters =
    CALCULATE(
        COUNTROWS(FactEncounter),
        ALLSELECTED(DimProvider)  // Remove provider from visual, keep date slicer
    )
RETURN
    DIVIDE(ProviderEncounters, TotalEncounters, 0)

User experience:
  Report State: User selects "January 2025" in date slicer
  Matrix:
    Provider    | Encounters | % of Total
    ------------|------------|------------
    Dr. Smith   | 245        | 1.3%        (245 / 18,450 January total)
    Dr. Jones   | 187        | 1.0%        (187 / 18,450 January total)

  Users happy: "% of Total respects my January filter" 
```

**ALL vs. ALLSELECTED decision framework:**

```
Use ALL when:
 Grand total should ALWAYS ignore all filters (true "all-time" total)
 Calculating % of absolute total regardless of slicers
 Reference calculations that must be constant

Example: "% of ALL patients ever served (2010-2025)"
         í Use ALL (ignore date slicers)

Use ALLSELECTED when:
 Total should respect report slicers but ignore visual filters
 Calculating % of filtered subset (user's current selection)
 User expects slicers to affect denominator

Example: "% of patients served THIS MONTH (user's date selection)"
         í Use ALLSELECTED (respect date slicer, ignore provider visual filter)

Use nothing (keep all filters) when:
 Calculation should respect ALL filters including visual
 Drill-down scenarios (filter continues to apply)

Example: "Count of encounters for THIS provider in THIS facility"
         í No ALL (respect all filters)
```

### Pitfall 3: Confusing Filter Context with Row Context

Trying to use RELATED or direct column references in measures (filter context) expecting them to work like calculated columns (row context).

**Impact**: Measures return unexpected blanks or errors, RELATED doesn't work in measures (error: "RELATED expects row context"), direct column references in measures show first value or error, confusion about when to use RELATED vs. CALCULATE, debugging nightmares (hard to diagnose context mismatch).

**Example mistake:**

```dax
// _Measures table - Measure
// L WRONG: RELATED doesn't work in measures (no row context)
Patient Name =
RELATED(DimPatient[PatientName])  // ERROR: RELATED expects row context

Why this fails:
  - Measures evaluate in FILTER CONTEXT (filtered table)
  - RELATED works in ROW CONTEXT (single row iteration)
  - Measure doesn't iterate rows, it aggregates filtered table
  - Error: "A single value for column 'PatientName' cannot be determined"
```

**Understanding the difference:**

```
CALCULATED COLUMN (row context):
                                     
 Current row: PatientKey = 1001       ê Processing ONE row
 RELATED(DimPatient[PatientName])      Works! (row context available)
 Result: "John Smith"                
                                     

MEASURE (filter context):
                                     
 Filtered table: 125,000 patients     ê Processing FILTERED SET
 RELATED(DimPatient[PatientName])      Error! (no single row)
 Which patient name? There are 125k! 
                                     
```

**Fix: Use aggregation or SELECTEDVALUE in measures**

```dax
//  CORRECT: Aggregation in measure (filter context)
Patient Count =
DISTINCTCOUNT(FactEncounter[PatientKey])  // Aggregate filtered table

//  CORRECT: SELECTEDVALUE when expecting single row
Selected Patient Name =
SELECTEDVALUE(
    DimPatient[PatientName],
    "Multiple patients selected"  // Fallback if >1 patient in filter
)

Usage:
  - Slicer with single patient selected í "John Smith"
  - Slicer with multiple patients í "Multiple patients selected"
  - No slicer (all patients) í "Multiple patients selected"
```

**Context cheat sheet:**

```
Context Type    | Created By                | Use Cases
----------------|---------------------------|---------------------------
Row Context     | Calculated columns        | RELATED, direct columns
                | Iterator functions        | Column references
                | (SUMX, FILTER, etc.)      |
                |                           |
Filter Context  | Report slicers            | Measures
                | Visual rows/columns       | CALCULATE
                | CALCULATE function        | Aggregations
                |                           |
Context         | CALCULATE in row context  | Calculated columns with
Transition      |                           | measures, iterator measures
```

## Healthcare Context

### Patient Attribution Calculations

Provider attribution requires understanding filter context to calculate patient panels correctly.

**Example: Primary Care Provider Patient Panel**

```dax
PCP Patient Panel =
// Patients attributed to selected provider as PCP
VAR AttributedPatients =
    CALCULATE(
        DISTINCTCOUNT(FactEncounter[PatientKey]),
        FactEncounter[ProviderRole] = "Primary Care Provider"
        // Filter context: Current provider + PCP role
    )

// Compare to all patients seen by provider (any role)
VAR AllPatientsSeenByProvider =
    DISTINCTCOUNT(FactEncounter[PatientKey])
    // Filter context: Current provider (all roles)

RETURN
    AttributedPatients

Usage in visual:
  Matrix rows: DimProvider[ProviderName]
  Values: [PCP Patient Panel], [AllPatientsSeenByProvider]

  ProviderName     | PCP Panel | All Patients Seen
  -----------------|-----------|------------------
  Dr. Smith (PCP)  | 1,247     | 1,389     (includes specialist referrals)
  Dr. Jones (Spec) | 0         | 892       (specialist, no PCP panel)

Filter context critical:
  - "PCP Panel" adds PCP role filter to existing provider filter
  - "All Patients" respects provider filter but no role filter
```

### Quality Measure Denominators

HEDIS/CMS quality measures require precise filter context control for eligible populations.

**Example: Diabetic Patients with HbA1c Test**

```dax
Diabetes HbA1c Testing Rate =
// Denominator: All diabetic patients (respect date filter for measurement year)
VAR EligibleDiabeticPatients =
    CALCULATE(
        DISTINCTCOUNT(DimPatient[PatientKey]),
        DimDiagnosis[DiagnosisCategory] = "Diabetes",
        ALLSELECTED(DimProvider)  // All providers (respect date slicer)
    )

// Numerator: Diabetic patients with HbA1c test
VAR TestedPatients =
    CALCULATE(
        DISTINCTCOUNT(FactLabResult[PatientKey]),
        DimDiagnosis[DiagnosisCategory] = "Diabetes",
        FactLabResult[LabTestType] = "HbA1c",
        ALLSELECTED(DimProvider)  // All providers
    )

VAR ComplianceRate = DIVIDE(TestedPatients, EligibleDiabeticPatients, 0)

RETURN
    ComplianceRate

Context considerations:
  - ALLSELECTED respects measurement year (date slicer)
  - Removes provider filter (organizational metric, not provider-specific)
  - Could use ALL(DimProvider) for true all-time organizational rate
  - ALLSELECTED more flexible (users can filter to specific year)
```

### Encounter-Level vs. Patient-Level Metrics

Understanding row vs. filter context prevents double-counting patients.

**Common mistake: Summing patient-level calculated column**

```dax
// DimPatient table - Calculated Column
Patient Chronic Condition Count =
CALCULATE(
    COUNTROWS(BridgePatientDiagnosis),
    BridgePatientDiagnosis[IsChronicCondition] = TRUE()
)

// _Measures table - Measure
// L WRONG: Sums column (row context) instead of counting patients
Total Chronic Conditions =
SUM(DimPatient[Patient Chronic Condition Count])

Problem:
  - If 1 patient has 3 encounters, patient counted 3 times
  - Result: Over-counting conditions by encounter volume

//  CORRECT: Aggregate at patient level (filter context)
Unique Patients with Chronic Conditions =
CALCULATE(
    DISTINCTCOUNT(DimPatient[PatientKey]),
    DimPatient[Patient Chronic Condition Count] > 0
)
```

## Learn More

### Official Documentation

- [Evaluation Contexts in DAX](https://learn.microsoft.com/en-us/dax/context-in-dax-formulas) - Microsoft's official explanation of filter and row context
- [CALCULATE Function](https://learn.microsoft.com/en-us/dax/calculate-function-dax) - Official CALCULATE documentation
- [Context Transition](https://learn.microsoft.com/en-us/power-bi/transform-model/desktop-row-context) - Microsoft's guide to context transition

### Expert Resources

- [SQLBI - Row Context and Filter Context](https://www.sqlbi.com/articles/row-context-and-filter-context-in-dax/) - Marco Russo and Alberto Ferrari's definitive guide
- [SQLBI - Context Transition in DAX](https://www.sqlbi.com/articles/context-transition-in-dax/) - Deep dive into context transition mechanics
- [The Definitive Guide to DAX - Chapter 2](https://www.sqlbi.com/books/the-definitive-guide-to-dax-2nd-edition/) - Evaluation contexts explained in detail
- [DAX Patterns - Context Transition](https://www.daxpatterns.com/context-transition/) - Practical patterns using context transition

### Video Content

- [SQLBI - Understanding Context Transition](https://www.sqlbi.com/tv/understanding-context-transition-in-dax/) - Visual explanation of context transition
- [Guy in a Cube - Filter Context Explained](https://www.youtube.com/c/GuyinaCube) - Patrick demonstrates filter context with examples

### Related Topics

- [03.2 - Variables & Code Readability](./03.2%20-%20Variables%20&%20Code%20Readability.md) - Variables capture values in current filter context
- [01.4 - Calculated Columns vs Measures](../01%20-%20Data%20Architecture%20&%20Semantic%20Modeling/01.4%20-%20Calculated%20Columns%20vs%20Measures.md) - Row context vs. filter context differences
- [03.4 - Time Intelligence Patterns](./03.4%20-%20Time%20Intelligence%20Patterns.md) - Time intelligence relies heavily on filter context manipulation
- [03.5 - Common DAX Anti-patterns](./03.5%20-%20Common%20DAX%20Anti-patterns.md) - Context-related errors and how to avoid them

---

*Last updated: October 21, 2025*
